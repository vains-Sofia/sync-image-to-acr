name: Sync Public Docker Images to ACR

on:
  issues:
    types: [opened, edited]

jobs:
  sync:
    if: startsWith(github.event.issue.title, 'sync:')
    runs-on: ubuntu-latest
    permissions:
      issues: write  # å¿…éœ€ï¼šç”¨äºè¯„è®ºå’Œå…³é—­ issue
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract image list from title or use defaults
        id: extract
        run: |
          TITLE="${{ github.event.issue.title }}"
          IMAGES=$(echo "$TITLE" | sed -n 's/^sync:\s*//p')
          if [ -z "$IMAGES" ]; then
            IMAGES="${{ secrets.DEFAULT_IMAGES }}"
          fi
          echo "images=$IMAGES" >> $GITHUB_OUTPUT

      - name: "ğŸ“ Pre-comment: syncing started"
        run: |
          IMAGES="${{ steps.extract.outputs.images }}"
          echo "ğŸš€ æ­£åœ¨åŒæ­¥ä»¥ä¸‹é•œåƒï¼Œè¯·ç¨å€™ï¼š" > comment.txt
          echo "" >> comment.txt
          
          for IMAGE in $IMAGES; do
          echo "- $IMAGE" >> comment.txt
          done
          
          gh issue comment ${{ github.event.issue.number }} -F comment.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Aliyun ACR
        run: |
          echo "${{ secrets.ACR_PASSWORD }}" | docker login -u "${{ secrets.ACR_USERNAME }}" --password-stdin ${{ secrets.ACR_REGISTRY }}

      - name: Sync public images to ACR
        id: sync
        run: |
          IMAGES="${{ steps.extract.outputs.images }}"
          echo "ğŸ“¦ ä»¥ä¸‹ä¸ºå¯ç”¨äºæ‹‰å–çš„ ACR é•œåƒå‘½ä»¤ï¼š" > comment.txt
          echo "" >> comment.txt
          
          # åˆ›å»ºå‡½æ•°æ¥å¤„ç†é•œåƒå
          normalize_image_name() {
            local original_image="$1"
            local normalized_image
          
            # å¤„ç†ä¸åŒçš„é•œåƒåæ ¼å¼
            if [[ "$original_image" == docker.io/* ]]; then
              # å»æ‰ docker.io å‰ç¼€: docker.io/library/nginx -> library/nginx
              normalized_image="${original_image#docker.io/}"
            elif [[ "$original_image" == */* ]]; then
              # åŒ…å«æ–œæ çš„é•œåƒå: minio/minio -> minio-minio
              normalized_image="${original_image//\//-}"
            else
              # å®˜æ–¹é•œåƒ: nginx -> nginx
              normalized_image="${original_image}"
            fi
          
            echo "$normalized_image"
          }
          
          for IMAGE in $IMAGES; do
            echo "â¡ï¸ å¤„ç†é•œåƒï¼š$IMAGE"
          
            # æ ‡å‡†åŒ–é•œåƒå
            NORMALIZED_NAME=$(normalize_image_name "$IMAGE")
          
            if docker pull "$IMAGE"; then
              # æ„å»º ACR é•œåƒè·¯å¾„
              ACR_IMAGE="${{ secrets.ACR_REGISTRY }}/github-proxy/$NORMALIZED_NAME"
          
              echo "ğŸ·ï¸ æ ‡è®°é•œåƒï¼š$IMAGE -> $ACR_IMAGE"
              docker tag "$IMAGE" "$ACR_IMAGE"
          
              echo "ğŸ“¤ æ¨é€é•œåƒï¼š$ACR_IMAGE"
              if docker push "$ACR_IMAGE"; then
                echo "âœ… æˆåŠŸæ¨é€ï¼š$ACR_IMAGE"
          
                # åœ¨è¯„è®ºä¸­æ˜¾ç¤ºåŸå§‹é•œåƒåå’Œ ACR é•œåƒåçš„å¯¹åº”å…³ç³»
                echo "**åŸå§‹é•œåƒ:** \`$IMAGE\`" >> comment.txt
                echo "\`\`\`bash" >> comment.txt
                echo "docker pull $ACR_IMAGE" >> comment.txt
                echo "\`\`\`" >> comment.txt
                echo "" >> comment.txt
              else
                echo "âŒ æ¨é€å¤±è´¥ï¼š$ACR_IMAGE"
                echo "âŒ æ¨é€å¤±è´¥ï¼š\`$IMAGE\` -> \`$ACR_IMAGE\`" >> comment.txt
                echo "" >> comment.txt
              fi
            else
              echo "âŒ æ— æ³•æ‹‰å–é•œåƒï¼š$IMAGEï¼ˆå¯èƒ½æ˜¯ç§æœ‰æˆ–ä¸å­˜åœ¨ï¼‰"
              echo "âŒ æ— æ³•æ‹‰å–é•œåƒï¼š\`$IMAGE\`ï¼ˆå¯èƒ½æ˜¯ç§æœ‰æˆ–ä¸å­˜åœ¨ï¼‰" >> comment.txt
              echo "" >> comment.txt
            fi
          
            echo "---"
          done

      - name: Comment on issue with pull commands
        run: |
          # æ·»åŠ è¯´æ˜å¤´éƒ¨
          echo "## ğŸ¯ é•œåƒåŒæ­¥å®Œæˆ" > final_comment.txt
          echo "" >> final_comment.txt
          echo "### ğŸš€ æ‹‰å–å‘½ä»¤" >> final_comment.txt
          echo "" >> final_comment.txt
          
          # åˆå¹¶åŸæœ‰çš„è¯„è®ºå†…å®¹
          cat comment.txt >> final_comment.txt
          
          gh issue comment ${{ github.event.issue.number }} -F final_comment.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Close the issue
        run: |
          gh issue close ${{ github.event.issue.number }} --comment "âœ… å…¬å…±é•œåƒåŒæ­¥å®Œæˆï¼ŒIssue å·²å…³é—­ã€‚"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}